<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Push Notification Test</title>
</head>
<body>
  <h2>🔔 Browser Push Notification Test</h2>
  <button id="subscribeBtn">Subscribe & Show Test Notification</button>

  <script>
    const publicKey = "BEdSufc6fv0fVmOQFWEpeqXn_yv2MeG8ioV46NjvdC8Ze-XzIHBqAulICLJyhbIqOfQPVuyV-MBbnzD4boKni6A";

    // --- Service Worker Code ---
    const swCode = `
      self.addEventListener("push", function (event) {
        const data = event.data ? event.data.text() : "No payload";
        event.waitUntil(
          self.registration.showNotification("📩 Push Notification", {
            body: data,
            icon: "https://via.placeholder.com/128"
          })
        );
      });
    `;
    const swBlob = new Blob([swCode], { type: "application/javascript" });
    const swUrl = URL.createObjectURL(swBlob);

    // --- Register Service Worker ---
    if ("serviceWorker" in navigator && "PushManager" in window) {
      navigator.serviceWorker.register(swUrl).then(() => {
        console.log("✅ Service Worker registered");
      });
    } else {
      alert("Push messaging is not supported in this browser.");
    }

    // --- Button click ---
    document.getElementById("subscribeBtn").addEventListener("click", async () => {
      try {
        const registration = await navigator.serviceWorker.ready;

        // Subscribe to push
        const subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(publicKey)
        });

        console.log("📡 Subscription object:", subscription);

        // Show local notification
        registration.showNotification("🎉 Test Notification", {
          body: "This is a local push test notification.",
          icon: "https://via.placeholder.com/128"
        });

        // Send subscription to backend
        const response = await fetch("http://localhost:8000/plants-mall-orders/api/order/push_notification/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            subscription: subscription,
            message: "🚀 Hello from the browser to Django!"
          })
        });

        if (!response.ok) {
          throw new Error("Server error: " + response.status);
        }

        const result = await response.json();
        console.log("✅ Backend response:", result);

      } catch (err) {
        console.error("❌ Error during subscription or fetch:", err);
      }
    });

    // --- Helper ---
    function urlBase64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
      const rawData = atob(base64);
      return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
    }
  </script>
</body>
</html>
